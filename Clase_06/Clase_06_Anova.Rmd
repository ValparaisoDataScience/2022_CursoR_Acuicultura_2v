---
title: "Clase 06 Análisis de varianza"
subtitle: 'Curso Introducción al Análisis de datos con R para la Acuicultura.'
author: Dr. José Gallardo Matus
institute: Pontificia Universidad Católica de Valparaíso 
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  beamer_presentation:
    theme: "Malmoe"
    colortheme: "seahorse"
    fonttheme: "professionalfonts"
    includes:
      in_header: mystyle.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(knitr)
library(broom)
```

# PLAN DE LA CLASE
**1.- Introducción**
    
- ¿Qué es un análisis de varianza?.   
- Modelos lineales en Anova.
- Hipótesis y supuestos.
- Interpretar resultados de análisis de varianza con R.

**2.- Práctica con R y Rstudio cloud**

- Realizar pruebas de hipótesis: Anova y posteriores.
- Realizar gráficas avanzadas con ggplot2. 
- Elaborar reporte dinámico en formato html.  

# ANOVA

**¿Qué es el análisis de varianza?**

Herramienta básica para analizar el efecto de uno o más factores (cada uno con dos o más niveles) en un experimento.

```{r, echo=FALSE, out.width = '100%' }
knitr::include_graphics("anova.png")
```

# PROBLEMA DE LAS COMPARACIONES MÚLTIPLES

**¿Por qué preferir anova y no múltiples t-test?**  
Porque con una t-test normal al aumentar el número de comparaciones múltiples se incrementa la tasa de error tipo I.

```{r, echo=FALSE, out.width = '60%',fig.align='center'}
knitr::include_graphics("problema.png")
```

Fuente[1]: [1]:doi:10.21037/jtd.2017.05.34 

# ANOVA: MODELOS LINENALES

Una forma muy conveniente de representar una ANOVA es mediante un modelo lineal.

**Modelo lineal para ANOVA de una vía**  
$y$ ~ $\mu$ + $\alpha$ + $\epsilon$   

**Modelo lineal para ANOVA de dos vías**  
$y$ ~ $\mu$ + $\alpha$ + $\beta$ + $\epsilon$     

**Modelo lineal para ANOVA de dos vías con interacción**  
$y$ ~ $\mu$ + $\alpha$ + $\beta$ + $\alpha$*$\beta$ + $\epsilon$

# ANOVA: HIPÓTESIS

**Hipótesis factor 1**  
**H~0~** : $\alpha_{1.1}$ = $\alpha_{1.2}$ = $\alpha_{1.3}$ 

**Hipótesis factor 2**  
**H~0~** : $\beta_{2.1}$ = $\beta_{2.2}$ = $\beta_{2.3}$  

**Hipótesis interacción**  
**H~0~** : $\alpha$*$\beta$ = 0

**Hipótesis Alternativa**  
**H~A~** : No todas las medias son iguales

# ANOVA PARA COMPARAR MEDIAS

**Si el test compara medias ¿Por qué se llama ANOVA?**  
Por que el estadístico **F** es un cociente de varianzas.     

**F** = $\frac{\sigma^2_{entre grupos}}{\sigma^2_{dentro grupos}}$

Mientras mayor es el estadístico **F**, más es la diferencia de medias entre grupos.  

```{r, echo=FALSE, out.width = '100%' }
knitr::include_graphics("varianza-f.png")
```

# SUPUESTOS DE UNA ANOVA

1. Independencia de las observaciones.\
&nbsp;
2. Normalidad.\
&nbsp;    
3. Homocedasticidad: homogeneidad de las varianzas.\
&nbsp;   
	
# TEST POSTERIORES (PRUEBAS A POSTERIORI)

**¿Para qué sirven?**

Para identificar que pares de niveles de uno o más factores son significativamente distintos entre sí. 

**¿Cuando usarlos?**

Sólo cuando se rechaza **H~0~** del ANOVA. 

**Tukey test**  
Es uno de los más usados, similar al *t-test*, pero corrige la tasa de error por el número de comparaciones.

# ESTUDIO DE CASO: TRUCHA ARCOIRIS

```{r}
My_Theme = theme(
  axis.title.x = element_text(size = 18),
  axis.text.x = element_text(size = 18),
  axis.title.y = element_text(size = 18),
  axis.text.y = element_text(size = 18))

my_data <- PlantGrowth
my_data%>% 
  ggplot(aes(x=group,y=weight,fill=group))+
      geom_boxplot()+
     theme(legend.position="none")+
     labs(x="Dietas",y="Peso (g)")+My_Theme
colnames(my_data) <- c("Peso","Dietas")
```

# ANOVA DE UNA VÍA

```{r, echo=TRUE}
res.aov <- lm(Peso ~ Dietas, data = my_data)
anova(res.aov)
```

# COMPARACIONES MULTIPLES

```{r , echo=TRUE}
fit_anova <- aov(res.aov)
tk <- TukeyHSD(fit_anova)
```

```{r}
tidy(tk) %>% kable(caption = "Prueba de Tukey.", digits=2,
col.names=c("Trat.","Contraste", "H0",
            "Diferencia", "IC-bajo","IC-alto",
            "p-ajustado"))
```


# ESTUDIO DE CASO: TILAPIA

```{r, out.width = '90%'}
my_data1 <- ToothGrowth
# my_data1
# table(my_data1$supp, my_data1$dose)
colnames(my_data1) <- c("Peso","Salinidad","Temperatura")
my_data1$Temperatura <- as.factor(my_data1$Temperatura)
levels(my_data1$Salinidad) <- c("Agua dulce","Agua de mar")
my_data1%>% 
  ggplot(aes(x=Temperatura,y=Peso,fill=Salinidad))+
      geom_boxplot()+
     labs(x="Temperatura",y="Peso (g)")+
  scale_x_discrete(labels = c('25ºC','30ºC','35ºC'))

```

# ANOVA DOS VIAS CON INTERACCIÓN
**res.aov2 <- lm(Peso ~ Temperatura * Salinidad, data = my_data1)**  
**anova(res.aov2)**
```{r, echo=F, out.width = '100%'}
# res.aov2 <- lm(Peso ~ Temperatura * Salinidad,
#                 data = my_data1)
# anova(res.aov2)
knitr::include_graphics("anova_lm2.png")
```


# PRÁCTICA ANÁLISIS DE DATOS

- El trabajo práctico se realiza en Rstudio.cloud.  
**Guía 06 Anova y posteriores**

# RESUMEN DE LA CLASE

- **Elaborar hipótesis de anova**.\
&nbsp;

- **Realizar análisis de varianza**.\
&nbsp;
    * 1 factor.  
    * 2 factores.
    * pruebas *a posteriori*.\
&nbsp;
    
- **Realizar gráficas avanzadas con ggplot2**    